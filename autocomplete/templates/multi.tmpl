{{define "lvt:autocomplete:multi:v1"}}
{{if .IsStyled}}
{{/* Tailwind CSS styled version */}}
<div class="relative" data-autocomplete="{{.ID}}" data-multi="true">
  <div class="flex flex-wrap gap-1 p-2 border border-gray-300 rounded-md shadow-sm focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 bg-white">
    {{range .SelectedItems}}
    <span class="inline-flex items-center gap-1 px-2 py-1 text-sm bg-blue-100 text-blue-800 rounded-md">
      {{.Label}}
      <button
        type="button"
        class="text-blue-600 hover:text-blue-800"
        lvt-click="remove_{{$.ID}}"
        lvt-data-value="{{.Value}}"
        aria-label="Remove {{.Label}}"
      >
        <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </span>
    {{end}}
    <input
      type="text"
      class="flex-1 min-w-[120px] px-2 py-1 border-0 focus:outline-none focus:ring-0"
      placeholder="{{if .HasSelectedItems}}{{else}}{{.Placeholder}}{{end}}"
      value="{{.Query}}"
      lvt-input="query_{{.ID}}"
      lvt-focus="focus_{{.ID}}"
      lvt-keydown="keydown_{{.ID}}"
      autocomplete="off"
      aria-autocomplete="list"
      aria-haspopup="listbox"
      aria-expanded="{{.Open}}"
    />
    {{if .Loading}}
    <div class="flex items-center">
      <svg class="w-5 h-5 text-gray-400 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
    {{else if .HasSelectedItems}}
    <button
      type="button"
      class="flex items-center text-gray-400 hover:text-gray-600"
      lvt-click="clear_multi_{{.ID}}"
      aria-label="Clear all"
    >
      <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>
    {{end}}
  </div>

  {{if .Open}}
  <ul
    class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto"
    role="listbox"
    lvt-click-away="blur_{{.ID}}"
  >
    {{$filtered := .FilteredExcludingSelected}}
    {{range $index, $suggestion := $filtered}}
    <li
      class="px-4 py-2 cursor-pointer
        {{if $suggestion.Disabled}}text-gray-400 cursor-not-allowed{{else if $.IsHighlighted $index}}bg-blue-600 text-white{{else}}text-gray-900 hover:bg-gray-100{{end}}"
      role="option"
      {{if not $suggestion.Disabled}}
      lvt-click="select_multi_{{$.ID}}"
      lvt-data-value="{{$suggestion.Value}}"
      {{end}}
      {{if $suggestion.Disabled}}aria-disabled="true"{{end}}
    >
      <div class="flex items-center">
        {{if $suggestion.Icon}}
        <span class="mr-2">{{$suggestion.Icon}}</span>
        {{end}}
        <div>
          <div class="font-medium">{{$suggestion.Label}}</div>
          {{if $suggestion.Description}}
          <div class="text-sm {{if $.IsHighlighted $index}}text-blue-200{{else}}text-gray-500{{end}}">{{$suggestion.Description}}</div>
          {{end}}
        </div>
      </div>
    </li>
    {{else}}
    <li class="px-4 py-2 text-gray-500 text-center">No suggestions found</li>
    {{end}}
  </ul>
  {{end}}
</div>
{{else}}
{{/* Unstyled semantic HTML version */}}
<div data-autocomplete="{{.ID}}" data-multi="true">
  <div>
    {{range .SelectedItems}}
    <span>
      {{.Label}}
      <button type="button" lvt-click="remove_{{$.ID}}" lvt-data-value="{{.Value}}">Ã—</button>
    </span>
    {{end}}
    <input
      type="text"
      placeholder="{{.Placeholder}}"
      value="{{.Query}}"
      lvt-input="query_{{.ID}}"
      lvt-focus="focus_{{.ID}}"
      lvt-keydown="keydown_{{.ID}}"
      autocomplete="off"
      aria-autocomplete="list"
      aria-haspopup="listbox"
      aria-expanded="{{.Open}}"
    />
    {{if .HasSelectedItems}}
    <button type="button" lvt-click="clear_multi_{{.ID}}">Clear all</button>
    {{end}}
  </div>

  {{if .Open}}
  <ul role="listbox" lvt-click-away="blur_{{.ID}}">
    {{$filtered := .FilteredExcludingSelected}}
    {{range $index, $suggestion := $filtered}}
    <li
      role="option"
      {{if not $suggestion.Disabled}}
      lvt-click="select_multi_{{$.ID}}"
      lvt-data-value="{{$suggestion.Value}}"
      {{end}}
    >
      {{$suggestion.Label}}
      {{if $suggestion.Description}}<small>{{$suggestion.Description}}</small>{{end}}
    </li>
    {{else}}
    <li>No suggestions found</li>
    {{end}}
  </ul>
  {{end}}
</div>
{{end}}
{{end}}
